**SSH absichern**

---

**1. Wir erstellen eine Sicherheitskopie der vorhandenen SSHD-Konfigurationsdatei**

Befehl: ```sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.BACKUP```

Überprüfen mit dem Befehl: ```sudo ls -aFlh /etc/ssh/sshd_config*```

Ausgabe:
```

-rw-r--r-- 1 root root 3,2K Jul 19 19:41 /etc/ssh/sshd_config
-rw-r--r-- 1 root root 3,2K Okt 15 12:58 /etc/ssh/sshd_config.BACKUP

```

> Optional: Mit dem Befehl ```sudo sed -i -e '/^#/d' -e '/^$/d' /etc/ssh/sshd_config``` entfernen wir alle Kommentare und Leerzeilen.

---

Anpassen der Datei _/etc/ssh/sshd_config_

Mit dem Befehl ```sudo nano /etc/ssh/sshd_config``` bearbeiten wir die Konfigurationsdatei.

| Einstellung                                     | Beschreibung |
| ----------------------------------------------- | ------------ |
| Include /etc/ssh/sshd_config.d/*.conf           | Bindet die festgelegte Konfigurationsdatei ein. Es können mehrere Pfadnamen festgelegt werden und jeder Pfadname darf Platzhalter enthalten, die expandiert und in lexikalischer Reihenfolge verarbeitet werden. Von Dateien ohne absolute Pfade wird vermutet, dass sie in /etc/ssh liegen. Innerhalb eines Match-Blocks kann eine Include -Direktive auftauchen, um bedingte Einbindung durchzuführen.                                                                                                                                                                                                                                                                                                                                                                   |
| Port 33771                                      | Legt die Port-Nummer fest, an der sshd auf Anfragen warten soll. Mehrere Optionen dieser Art sind erlaubt.<br/><br/>Standard-Einstellung: 22                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| KbdInteractiveAuthentication no                 | Legt fest, ob interaktive Anmeldung über die Tastatur erlaubt wird. Das Argument für dieses Schlüsselwort muss yes oder no lauten. Die Vorgabe ist, den Wert zu verwenden, auf den ChallengeResponseAuthentication gesetzt ist.<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| UsePAM yes                                      | Aktiviert die "Pluggable Authentication Module"-Schnittstelle. Falls auf yes gesetzt wird dies zusätzlich zu der für alle Authentifizerungen erfolgenden PAM-Konten und -Sitzungsmodulverarbeitungen die PAM-Authentifizierung mittels ChallengeResponseAuthentication und PasswordAuthentication aktivieren. Da die PAM-challenge-response-Authentifizierung normalerweise eine äquivalente Rolle zur Passwort-Authentifizierung spielt, sollten Sie entweder PasswordAuthentication oder ChallengeResponseAuthentication deaktiveren. Falls UsePAM aktiviert ist, müssen Sie zwingend sshd als Benutzer root ausführen.<br/><br/>Standard-Einstellung: no                                                                                                                |
| PrintMotd no                                    | Legt fest, ob sshd /etc/motd ausgeben soll, wenn sich ein Benutzer interaktiv anmeldet.<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| AcceptEnv LANG LC_*                             | Legt fest, welche vom Client gesandten Umgebungsvariablen in die environ der Sitzung kopiert werden. Siehe SendEnv und SetEnv in ssh_config für die Konfiguration des Clients. Die Umgebungsvariable TERM wird immer akzeptiert, wenn der Client ein Pseudo-Terminal erbittet, da sie vom Protokoll gefordert wird. Variablen werden durch den Namen, der Platzhalterzeichen ‘*’ und ‘?’ enthalten darf, festgelegt. Mehrere Umgebungsvariablen können durch Leerraum getrennt oder auf mehrere AcceptEnv -Direktiven verteilt werden. Warnung: Einige Umgebungsvariablen können zur Umgehung eingeschränkter Benutzerumgebungen verwandt werden. Daher sollten Sie beim Einsatz dieser Direktive vorsichtig sein.<br/><br/>Standard-Einstellung: keine Umgebungsvariablen |
| Subsystem   sftp   /usr/lib/openssh/sftp-server | Konfiguriert ein externes Subsystem. Argumente sollten ein Subsystemname und ein Befehl sein (mit optionalen Argumenten), um eine Subsystem-Anfrage auszuführen. Der Befehl sftp-server implementiert das SFTP-Dateiübertragungs-Subsystem. Alternativ implementiert der Name internal-sftp einen In-Prozess-SFTP-Server. Dies kann Konfigurationen bei der Verwendung von ChrootDirectory vereinfachen, bei der eine andere Dateisystemwurzel auf Clients erzwungen wird.<br/><br/>Standard-Einstellung: keine Subsysteme definiert                                                                                                                                                                                                                                       |
| PermitRootLogin no                              | Legt fest, ob root sich mittels ssh(1) anmelden kann. Das Argument muss yes, prohibit-password, forced-commands-only oder no sein.<br/><br/>Standard-Einstellung: prohibit-password                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| MaxAuthTries 3                                  | Legt die maximale Anzahl von Authentifizierungsversuchen fest, die pro Verbindung erlaubt sind. Sobald die Anzahl der Fehlschläge die Hälfte dieses Wertes erreicht hat, werden zusätzliche Fehlschläge protokolliert.<br/><br/>Standard-Einstellung: 6                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| LoginGraceTime 20                               | Der Server beendet die Verbindung nach dieser Zeit, falls sich der Benutzer nicht erfolgreich angemeldet hat. Falls der Wert 0 ist, gibt es keine Zeitbeschränkung.<br/><br/>Standard-Einstellung: 120                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| PasswordAuthentication no                       | Legt fest, ob Passwortauthentifizierung erlaubt ist.<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| PermitEmptyPasswords no                         | Wenn Passwortauthentifizierung erlaubt ist, legt dies fest, ob der Server Anmeldungen für Konten mit leeren Passwortzeichenketten erlaubt.<br/><br/>Standard-Einstellung: no                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ChallengeResponseAuthentication no              | Legt fest, ob die Challenge-Respones-Authentifizierung erlaubt ist (z.B. über PAM).<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| KerberosAuthentication no                       | Legt fest, ob das durch den Benutzer für PasswordAuthentication bereitgestellte Passwort mittels des Kerberos KDCs validiert wird. Um diese Option zu verwenden, benötigt der Server eine Kerberos-Servtab, die die Überprüfung der Identität des KDCs erlaubt.<br/><br/>Standard-Einstellung: no                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| GSSAPIAuthentication no                         | Legt fest, ob die GSSAPI-basierte Benutzerauthentifizierung erlaubt ist.<br/><br/>Standard-Einstellung: no                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| X11Forwarding no                                | Legt fest, ob X11-Weiterleitung erlaubt ist. Das Argument muss entweder yes oder no sein.<br/><br/>Standard-Einstellung: no                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| PermitUserEnvironment no                        | Legt fest, ob die Optionen ~/.ssh/environment und environment= in ~/.ssh/authorized_keys durch sshd verarbeitet werden. Gültige Optionen sind yes, no oder eine Muster-Liste, die angibt, welche Umgebungsvariablennamen akzeptiert werden (beispielsweise "LANG,LC_*").<br/><br/>Standard-Einstellung: no                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| AllowAgentForwarding no                         | Legt fest, ob Weiterleitung mit ssh-agent erlaubt ist.<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| AllowTcpForwarding no                           | Legt fest, ob TCP-Weiterleitung erlaubt ist. Die verfügbaren Optionen sind yes (die Vorgabe), all (um TCP-Weiterleitung zu erlauben), no (um alle TCP-Weiterleitungen zu verhindern), local (um nur lokale (aus Sicht von ssh) Weiterleitung zu erlauben) und remote (um nur ferne Weiterleitung zu erlauben).<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                          |
| PermitTunnel no                                 | Legt fest, ob tun-Geräteweiterleitung erlaubt ist. Das Argument muss entweder yes, point-to-point (Ebene 3), ethernet (Ebene 2) oder no sein. Festlegung von yes erlaubt sowohl point-to-point als auch ethernet.<br/><br/>Standard-Einstellung: no                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| DebianBanner no                                 | Legt fest, ob die Distributions-spezifische zusätzliche Versionsendung während des anfänglichen Protokoll-Handshakes eingebunden wird.<br/><br/>Standard-Einstellung: yes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

Mit dem Befehl ```sudo systemctl restart ssh``` restarten wir den SSH-Dienst.

Mit dem Befehl ```sudo systemctl status ssh``` prüfen wir den SSH-Dienst.

Ausgabe:

```

ssh.service - OpenBSD Secure Shell server
     Loaded: loaded (/lib/systemd/system/ssh.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2023-10-15 13:34:19 UTC; 5s ago
       Docs: man:sshd(8)
             man:sshd_config(5)
    Process: 1708 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=0/SUCCESS)
   Main PID: 1709 (sshd)
      Tasks: 1 (limit: 4515)
     Memory: 1.7M
        CPU: 15ms
     CGroup: /system.slice/ssh.service
             └─1709 "sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups"

Okt 15 13:34:19 server1 systemd[1]: Starting OpenBSD Secure Shell server...
Okt 15 13:34:19 server1 sshd[1709]: Server listening on 0.0.0.0 port 33771.
Okt 15 13:34:19 server1 sshd[1709]: Server listening on :: port 33771.
Okt 15 13:34:19 server1 systemd[1]: Started OpenBSD Secure Shell server.

```

---

_Weiterführende Informationen:_
* [ssh](https://wiki.ubuntuusers.de/SSH/)
* [sed](https://wiki.ubuntuusers.de/sed/)
